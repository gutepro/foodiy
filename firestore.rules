rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function validCategories(categories) {
      return categories is list
        && categories.size() >= 1
        && categories.size() <= 5
        && categories.all(cat, cat is string && cat.size() > 0);
    }

    function isPublicCookbookWrite() {
      return request.resource.data.isPublic == true
        || (!('isPublic' in request.resource.data)
            && (resource == null || resource.data.isPublic == true));
    }

    function cookbookCategoriesValid() {
      return !isPublicCookbookWrite()
        || validCategories(request.resource.data.categories);
    }

    match /recipes/{recipeId} {
      // TODO(Phase2): tighten to owner OR recipe.publicVisibility == true once
      // denormalized visibility is in place.
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null
        && request.auth.uid == resource.data.chefId;
      allow delete: if request.auth != null
        && request.auth.uid == resource.data.chefId;
    }

    match /chef_playlists/{playlistId} {
      allow read, write: if request.auth != null;
    }

    match /cookbooks/{cookbookId} {
      allow read: if resource.data.isPublic == true || (request.auth != null && request.auth.uid == resource.data.ownerId);
      allow create: if request.auth != null
        && cookbookCategoriesValid();
      allow update, delete: if request.auth != null
        && cookbookCategoriesValid()
        && (
          (!(resource.data.ownerId is string) || resource.data.ownerId == '')
            || request.auth.uid == resource.data.ownerId
        );
    }

    // Cookbook entries live under /cookbooks/{cookbookId}/entries/{recipeId}.
    // Public cookbooks should never leak private recipes to other users.
    match /cookbooks/{cookbookId}/entries/{recipeId} {
      allow read: if true;

      function cookbookOwnerUid() {
        return get(/databases/$(database)/documents/cookbooks/$(cookbookId)).data.ownerId;
      }

      function cookbookIsPublic() {
        return get(/databases/$(database)/documents/cookbooks/$(cookbookId)).data.isPublic == true;
      }

      allow create, update, delete: if request.auth != null
        && (
          (!(cookbookOwnerUid() is string) || cookbookOwnerUid() == '')
            || request.auth.uid == cookbookOwnerUid()
        )
        // Phase 1: allow entries regardless of recipe.isPublic; Phase 2 will
        // enforce derived visibility via publicCookbookIds/publicVisibility.
        ;
    }

    match /public_playlists/{playlistId} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    match /users/{userId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Development catch all: any other collection for authenticated users
    match /{document=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null
        && !request.path.matches('^/databases/$(database)/documents/recipes/.*')
        && !request.path.matches('^/databases/$(database)/documents/cookbooks/.*');
    }
  }
}
